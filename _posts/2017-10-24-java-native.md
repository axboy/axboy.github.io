---
layout: post
title: "java调用native方法(mac)"
categories: java
---

### 前言

今天在看HashMap源码，后来点到了Object类，看到了几个native标识的方法，不懂，就先把native方法科普一下，先搞定了，明天再补上HashMap的分析。

> native方法称为本地方法。在java源程序中以关键字“native”声明，不提供函数体。其实现使用C/C++语言在另外的文件中编写，编写的规则遵循Java本地接口的规范Java native Interface(简称JNI)。简而言就是Java中声明的可调用的使用C/C++实现的方法。

### 具体实现

1. 编写有natives声明的方法的java类

    不多说，代码如下

    ```java
    package local.zcw.demo;

    /**
    * 作者 zcw
    * 时间 2017/10/24 18:04
    * 版本 1.0.0
    * 描述 TODO
    */
    public class MyNative {

        static {
            System.loadLibrary("MyNative");
        }

        public static native void sayHello();

        public static void main(String[] args) {
            MyNative.sayHello();
        }
    }
    ```

2. 使用javac命令编译java类

    ```sh
    cd src/
    javac local/zcw/demo/MyNative.java
    ```

3. 使用javah -jni 命令生成*.h头文件

    ```sh
    javah -jni local.zcw.demo.MyNative
    ```

    生成的文件内容如下

    ```c
    /* DO NOT EDIT THIS FILE - it is machine generated */
    #include <jni.h>
    /* Header for class local_zcw_demo_MyNative */

    #ifndef _Included_local_zcw_demo_MyNative
    #define _Included_local_zcw_demo_MyNative
    #ifdef __cplusplus
    extern "C" {
    #endif
    /*
    * Class:     local_zcw_demo_MyNative
    * Method:    sayHello
    * Signature: ()V
    */
    JNIEXPORT void JNICALL Java_local_zcw_demo_MyNative_sayHello
    (JNIEnv *, jclass);

    #ifdef __cplusplus
    }
    #endif
    #endif
    ```

4. 使用c语言实现本地方法

    ```c
    #include "jni.h"
    #include "local_zcw_demo_MyNative.h"
    #include <stdio.h>

    JNIEXPORT void JNICALL Java_local_zcw_demo_MyNative_sayHello(JNIEnv * env, jclass obj)
    {
        printf("hello by c\n");
    }
    ```

5. 将本地方法编写的文件生成动态链接库

    ```sh
    gcc -dynamiclib -I ${JAVA_HOME}/include/  \
        -I ${JAVA_HOME}/include/darwin/ \
        local_zcw_demo_MyNative.c \
        -o libMyNative.jnilib
    ```

6. 执行代码

    ```sh
    java local.zcw.demo.MyNative
    ```

### 其它

项目目录如下图,代码[下载](https://github.com/zengchw/zcw.learn/tree/master/java/native-method)

![project](/images/java-native-01.png)

完整的命令如下图

![whole](/images/java-native-02.png)

### 参考文章

- [Mac下Java的native方法以及JNI调用C语言](http://blog.csdn.net/u010853261/article/details/53470514)

- [Java调用C（Linux下实现Java本地方法）](http://blog.csdn.net/kangkanglou/article/details/5807787)

- [在 Windows 中实现 Java 本地方法](https://www.ibm.com/developerworks/cn/java/jnimthds/)